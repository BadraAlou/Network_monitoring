{% extends './base.html' %}
{% load static %}
{% block title %}Tableau de Bord | 2IEM_Security{% endblock %}

{% block content %}
<div id="global-loader" class="fixed inset-0 bg-white bg-opacity-60 flex items-center justify-center z-50 hidden">
  <div class="w-16 h-16 border-4 border-blue-400 border-dashed rounded-full animate-spin"></div>
</div>

<div class="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-100 relative overflow-hidden">
  <!-- Animated Background Elements -->
  <div class="absolute inset-0 overflow-hidden pointer-events-none">
    <div class="absolute -top-40 -right-40 w-80 h-80 bg-gradient-to-br from-blue-400/20 to-purple-600/20 rounded-full blur-3xl animate-pulse"></div>
    <div class="absolute -bottom-40 -left-40 w-80 h-80 bg-gradient-to-br from-indigo-400/20 to-cyan-600/20 rounded-full blur-3xl animate-pulse" style="animation-delay: 2s;"></div>
  </div>

  <!-- Enhanced Header -->
  <div class="relative bg-white/90 backdrop-blur-xl border-b border-gray-200/50 sticky top-0 z-50 shadow-lg">
    <div class="px-4 sm:px-6 lg:px-8 py-6">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-6">
          <div class="flex items-center space-x-4">
            <div class="relative">
              <div class="w-12 h-12 bg-gradient-to-br from-blue-600 via-indigo-600 to-purple-700 rounded-2xl flex items-center justify-center shadow-xl">
                <img src="{% static 'images/theme/logo-final.jpg' %}" alt="2IEM" class="w-32 h-14 rounded-full object-cover">
              </div>
              <div class="absolute -inset-2 bg-gradient-to-br from-blue-600 to-purple-700 rounded-2xl blur opacity-30 animate-pulse"></div>
            </div>
            <div>
              <h1 class="text-2xl font-black text-gray-900 bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent">
                2IEM Security Center
              </h1>
              <p class="text-sm text-gray-600 font-medium">Surveillance réseau intelligente en temps réel</p>
            </div>
          </div>
        </div>

        <!-- Enhanced Network Status -->
        <div class="hidden md:flex items-center space-x-6">
          <div class="flex items-center space-x-3 bg-gradient-to-r from-green-50 to-emerald-50 px-6 py-3 rounded-2xl border border-green-200/50 shadow-lg" id="network-status">
            <div class="relative">
              <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse" id="connection-indicator"></div>
              <div class="absolute inset-0 w-3 h-3 bg-green-400 rounded-full animate-ping opacity-75"></div>
            </div>
            <span class="text-sm font-bold text-green-800" id="network-name">
              Réseau: {{ network_info.wifi_name|default:"Détection..." }}
            </span>
          </div>

          <div class="flex items-center space-x-6 text-sm text-gray-600 bg-white/80 backdrop-blur-sm px-6 py-3 rounded-2xl border border-gray-200/50 shadow-lg">
            <div class="flex items-center space-x-2">
              <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9v-9m0-9v9"></path>
              </svg>
              <span class="font-semibold" id="local-ip-header">{{ network_info.local_ip|default:"--" }}</span>
            </div>
            <div class="flex items-center space-x-2">
              <svg class="w-4 h-4 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              <span class="font-semibold" id="last-update">{% now "H:i" %}</span>
            </div>
          </div>

          <button onclick="refreshNetworkInfo()" class="group bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white px-6 py-3 rounded-2xl transition-all duration-300 flex items-center space-x-3 shadow-lg hover:shadow-xl transform hover:scale-105" id="refresh-btn">
            <svg class="w-5 h-5 group-hover:rotate-180 transition-transform duration-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
            <span class="font-semibold">Actualiser</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="relative px-4 sm:px-6 lg:px-8 py-8 pb-16">
    <!-- Enhanced Metrics Cards -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8 mb-12">
      <a href="{% url 'theme:liste_ordinateurs' %}" class="group transform transition-all duration-500 hover:scale-105">
        <div class="relative bg-white/90 backdrop-blur-sm rounded-3xl shadow-xl hover:shadow-2xl transition-all duration-500 p-8 border border-white/50 group-hover:border-blue-300/50 overflow-hidden">
          <div class="absolute inset-0 bg-gradient-to-br from-blue-500/5 to-indigo-500/5 opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
          <div class="relative flex items-center justify-between">
            <div>
              <p class="text-sm font-bold text-gray-500 uppercase tracking-wider mb-2">Total Appareils</p>
              <p class="text-4xl font-black text-gray-900 mb-2 group-hover:text-blue-600 transition-colors duration-300">{{ total_devices }}</p>
              <p class="text-sm text-gray-600 font-medium">Appareils détectés</p>
            </div>
            <div class="relative">
              <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl flex items-center justify-center group-hover:scale-110 transition-transform duration-300 shadow-lg">
                <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                </svg>
              </div>
              <div class="absolute -inset-2 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl blur opacity-0 group-hover:opacity-30 transition-opacity duration-300"></div>
            </div>
          </div>
        </div>
      </a>

      <div class="group transform transition-all duration-500 hover:scale-105">
        <div class="relative bg-white/90 backdrop-blur-sm rounded-3xl shadow-xl hover:shadow-2xl transition-all duration-500 p-8 border border-white/50 group-hover:border-green-300/50 overflow-hidden">
          <div class="absolute inset-0 bg-gradient-to-br from-green-500/5 to-emerald-500/5 opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
          <div class="relative flex items-center justify-between">
            <div>
              <p class="text-sm font-bold text-gray-500 uppercase tracking-wider mb-2">En Ligne</p>
              <p class="text-4xl font-black text-green-600 mb-2 group-hover:scale-110 transition-transform duration-300">{{ total_online }}</p>
              <p class="text-sm text-gray-600 font-medium">{% widthratio total_online total_devices 100 %}% du réseau</p>
            </div>
            <div class="relative">
              <div class="w-16 h-16 bg-gradient-to-br from-green-500 to-emerald-600 rounded-2xl flex items-center justify-center group-hover:scale-110 transition-transform duration-300 shadow-lg">
                <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
              </div>
              <div class="absolute -inset-2 bg-gradient-to-br from-green-500 to-emerald-600 rounded-2xl blur opacity-0 group-hover:opacity-30 transition-opacity duration-300"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="group transform transition-all duration-500 hover:scale-105">
        <div class="relative bg-white/90 backdrop-blur-sm rounded-3xl shadow-xl hover:shadow-2xl transition-all duration-500 p-8 border border-white/50 group-hover:border-red-300/50 overflow-hidden">
          <div class="absolute inset-0 bg-gradient-to-br from-red-500/5 to-rose-500/5 opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
          <div class="relative flex items-center justify-between">
            <div>
              <p class="text-sm font-bold text-gray-500 uppercase tracking-wider mb-2">Hors Ligne</p>
              <p class="text-4xl font-black text-red-600 mb-2 group-hover:scale-110 transition-transform duration-300">{{ total_offline }}</p>
              <p class="text-sm text-gray-600 font-medium">{% if total_offline > 0 %}Nécessite attention{% else %}Tout va bien{% endif %}</p>
            </div>
            <div class="relative">
              <div class="w-16 h-16 bg-gradient-to-br from-red-500 to-rose-600 rounded-2xl flex items-center justify-center group-hover:scale-110 transition-transform duration-300 shadow-lg">
                <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                </svg>
              </div>
              <div class="absolute -inset-2 bg-gradient-to-br from-red-500 to-rose-600 rounded-2xl blur opacity-0 group-hover:opacity-30 transition-opacity duration-300"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="group transform transition-all duration-500 hover:scale-105">
          <a href="{% url 'theme:alert_list' %}" class="group transform transition-all duration-500 hover:scale-105">
        <div class="relative bg-white/90 backdrop-blur-sm rounded-3xl shadow-xl hover:shadow-2xl transition-all duration-500 p-8 border border-white/50 group-hover:border-amber-300/50 overflow-hidden">
          <div class="absolute inset-0 bg-gradient-to-br from-amber-500/5 to-orange-500/5 opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
          <div class="relative flex items-center justify-between">
            <div>
              <p class="text-sm font-bold text-gray-500 uppercase tracking-wider mb-2">Alertes Actives</p>
              <p class="text-4xl font-black text-amber-600 mb-2 group-hover:scale-110 transition-transform duration-300">{{ total_alerts }}</p>
              <p class="text-sm text-gray-600 font-medium">{% if total_alerts > 0 %}À surveiller{% else %}Aucune alerte{% endif %}</p>
            </div>
            <div class="relative">
              <div class="w-16 h-16 bg-gradient-to-br from-amber-500 to-orange-600 rounded-2xl flex items-center justify-center group-hover:scale-110 transition-transform duration-300 shadow-lg">
                <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                </svg>
              </div>
              <div class="absolute -inset-2 bg-gradient-to-br from-amber-500 to-orange-600 rounded-2xl blur opacity-0 group-hover:opacity-30 transition-opacity duration-300"></div>
            </div>
          </div>
        </div>
          </a>
      </div>
    </div>

    <!-- Enhanced Network Information Section -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-12">
      <div class="group bg-white/90 backdrop-blur-sm rounded-3xl shadow-xl hover:shadow-2xl transition-all duration-500 p-8 border border-white/50 hover:border-blue-300/50">
        <h3 class="text-xl font-black text-gray-900 mb-6 flex items-center">
          <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl flex items-center justify-center mr-3">
            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.111 16.404a5.5 5.5 0 717.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.141 0M1.394 9.393c5.857-5.857 15.355-5.857 21.213 0"></path>
            </svg>
          </div>
          Informations Réseau Temps Réel
        </h3>
        <div class="space-y-4">
          <div class="flex justify-between items-center p-3 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl border border-blue-100">
            <span class="text-gray-700 font-medium">Nom du réseau WiFi</span>
            <span class="font-bold text-blue-600" id="detailed-network-name">{{ network_info.wifi_name|default:"Détection..." }}</span>
          </div>
          <div class="flex justify-between items-center p-3 bg-gradient-to-r from-gray-50 to-slate-50 rounded-xl border border-gray-100">
            <span class="text-gray-700 font-medium">Adresse IP locale</span>
            <span class="font-bold text-gray-700" id="local-ip">{{ network_info.local_ip|default:"Récupération..." }}</span>
          </div>
          <div class="flex justify-between items-center p-3 bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl border border-green-100">
            <span class="text-gray-700 font-medium">Adresse IP publique</span>
            <span class="font-bold text-green-600" id="public-ip">{{ network_info.public_ip|default:"Récupération..." }}</span>
          </div>
          <div class="flex justify-between items-center p-3 bg-gradient-to-r from-purple-50 to-indigo-50 rounded-xl border border-purple-100">
            <span class="text-gray-700 font-medium">Nom d'hôte</span>
            <span class="font-bold text-purple-600" id="hostname">{{ network_info.hostname|default:"--" }}</span>
          </div>
          <div class="flex justify-between items-center p-3 bg-gradient-to-r from-cyan-50 to-blue-50 rounded-xl border border-cyan-100">
            <span class="text-gray-700 font-medium">Système</span>
            <span class="font-bold text-cyan-600" id="system">{{ network_info.system|default:"--" }}</span>
          </div>
        </div>
      </div>

      <div class="group bg-white/90 backdrop-blur-sm rounded-3xl shadow-xl hover:shadow-2xl transition-all duration-500 p-8 border border-white/50 hover:border-red-300/50">
        <h3 class="text-xl font-black text-gray-900 mb-6 flex items-center">
          <div class="w-8 h-8 bg-gradient-to-br from-red-500 to-rose-600 rounded-xl flex items-center justify-center mr-3">
            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
            </svg>
          </div>
          Alertes Récentes
        </h3>
        <div class="space-y-4" id="alerts-container">
          <!-- Les alertes seront chargées ici par JavaScript -->
          <div class="flex items-center justify-center py-8">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-red-600"></div>
          </div>
        </div>
      </div>

      <div class="group bg-white/90 backdrop-blur-sm rounded-3xl shadow-xl hover:shadow-2xl transition-all duration-500 p-8 border border-white/50 hover:border-green-300/50">
        <h3 class="text-xl font-black text-gray-900 mb-6 flex items-center">
          <div class="w-8 h-8 bg-gradient-to-br from-green-500 to-emerald-600 rounded-xl flex items-center justify-center mr-3">
            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
            </svg>
          </div>
          Surveillance Active
        </h3>
        <div class="space-y-4">
          <div class="flex justify-between items-center p-3 bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl border border-green-100">
            <span class="text-gray-700 font-medium">Scan réseau</span>
            <span class="px-3 py-1 bg-green-500 text-white text-xs font-bold rounded-full flex items-center">
              <div class="w-2 h-2 bg-white rounded-full mr-2 animate-pulse"></div>
              Actif
            </span>
          </div>
          <div class="flex justify-between items-center p-3 bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl border border-green-100">
            <span class="text-gray-700 font-medium">Détection d'intrusion</span>
            <span class="px-3 py-1 bg-green-500 text-white text-xs font-bold rounded-full flex items-center">
              <div class="w-2 h-2 bg-white rounded-full mr-2 animate-pulse"></div>
              Actif
            </span>
          </div>
          <div class="flex justify-between items-center p-3 bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl border border-green-100">
            <span class="text-gray-700 font-medium">Monitoring temps réel</span>
            <span class="px-3 py-1 bg-green-500 text-white text-xs font-bold rounded-full flex items-center">
              <div class="w-2 h-2 bg-white rounded-full mr-2 animate-pulse"></div>
              Actif
            </span>
          </div>
          <div class="flex justify-between items-center p-3 bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl border border-green-100">
            <span class="text-gray-700 font-medium">Alertes automatiques</span>
            <span class="px-3 py-1 bg-green-500 text-white text-xs font-bold rounded-full flex items-center">
              <div class="w-2 h-2 bg-white rounded-full mr-2 animate-pulse"></div>
              Actif
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- Enhanced Charts Section -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-12">
      <div class="bg-white/90 backdrop-blur-sm rounded-3xl shadow-xl hover:shadow-2xl transition-all duration-500 p-8 border border-white/50 hover:border-blue-300/50">
        <div class="flex items-center justify-between mb-8">
          <h3 class="text-xl font-black text-gray-900 flex items-center">
            <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl flex items-center justify-center mr-3">
              <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
              </svg>
            </div>
            Évolution des Appareils
          </h3>
          <div class="flex space-x-2">
            <span class="px-4 py-2 text-xs bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-full font-bold">30 derniers scans</span>
          </div>
        </div>
        <div style="height: 350px;">
          <canvas id="devicesLineChart"></canvas>
        </div>
      </div>

      <div class="bg-white/90 backdrop-blur-sm rounded-3xl shadow-xl hover:shadow-2xl transition-all duration-500 p-8 border border-white/50 hover:border-purple-300/50">
        <h3 class="text-xl font-black text-gray-900 mb-8 flex items-center">
          <div class="w-8 h-8 bg-gradient-to-br from-purple-500 to-pink-600 rounded-xl flex items-center justify-center mr-3">
            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"></path>
            </svg>
          </div>
          Répartition des Statuts
        </h3>
        <div style="height: 350px;" class="flex items-center justify-center">
          <canvas id="statusDoughnutChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Enhanced Alerts and Events Section -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
      <div class="bg-white/90 backdrop-blur-sm rounded-3xl shadow-xl hover:shadow-2xl transition-all duration-500 p-8 border border-white/50 hover:border-amber-300/50">
        <h3 class="text-xl font-black text-gray-900 mb-8 flex items-center">
          <div class="w-8 h-8 bg-gradient-to-br from-amber-500 to-orange-600 rounded-xl flex items-center justify-center mr-3">
            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
          </div>
          Répartition des Alertes
        </h3>
        <div style="height: 300px;" class="flex items-center justify-center">
          <canvas id="alertChart"></canvas>
        </div>
      </div>

      <div class="bg-white/90 backdrop-blur-sm rounded-3xl shadow-xl hover:shadow-2xl transition-all duration-500 p-8 border border-white/50 hover:border-indigo-300/50">
        <h3 class="text-xl font-black text-gray-900 mb-8 flex items-center">
          <div class="w-8 h-8 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center mr-3">
            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
            </svg>
          </div>
          Événements Récents
        </h3>
        <div class="space-y-4 max-h-[350px] overflow-y-auto custom-scrollbar" id="events-container">
          <!-- Les événements seront chargés ici par JavaScript -->
          <div class="flex items-center justify-center py-8">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// Variables globales
let isRefreshing = false;
let alertsChart = null;
let eventsRefreshInterval = null;

// Configuration des couleurs
const colors = {
  primary: '#3b82f6',
  success: '#10b981',
  warning: '#f59e0b',
  danger: '#ef4444',
  info: '#06b6d4',
  purple: '#8b5cf6',
  indigo: '#6366f1'
};

// Fonction pour actualiser les informations réseau
async function refreshNetworkInfo() {
  if (isRefreshing) return;

  isRefreshing = true;
  const refreshBtn = document.getElementById('refresh-btn');
  const networkName = document.getElementById('network-name');

  // Animation de chargement
  if (refreshBtn) {
    refreshBtn.innerHTML = `
      <svg class="w-5 h-5 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
      </svg>
      <span class="font-semibold">Actualisation...</span>
    `;
  }

  try {
    const response = await fetch('/systeme/api/network-info/', {
      method: 'GET',
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
        'Content-Type': 'application/json',
      }
    });

    if (response.ok) {
      const data = await response.json();
      updateNetworkDisplay(data);
      showNotification('Informations réseau mises à jour', 'success');
    } else {
      throw new Error('Erreur de récupération des données');
    }

  } catch (error) {
    console.error('Erreur lors de l\'actualisation:', error);
    showNotification('Erreur lors de la récupération des informations réseau', 'error');

  } finally {
    isRefreshing = false;
    if (refreshBtn) {
      refreshBtn.innerHTML = `
        <svg class="w-5 h-5 group-hover:rotate-180 transition-transform duration-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
        </svg>
        <span class="font-semibold">Actualiser</span>
      `;
    }
  }
}

// Fonction pour mettre à jour l'affichage réseau
function updateNetworkDisplay(data) {
  const elements = {
    'network-name': data.wifi_name ? `Réseau: ${data.wifi_name}` : null,
    'local-ip-header': data.local_ip,
    'detailed-network-name': data.wifi_name,
    'local-ip': data.local_ip,
    'public-ip': data.public_ip,
    'hostname': data.hostname,
    'system': data.system,
    'last-update': new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })
  };

  Object.entries(elements).forEach(([id, value]) => {
    const element = document.getElementById(id);
    if (element && value) {
      element.textContent = value;
    }
  });
}

// Fonction pour charger les alertes
async function loadAlerts() {
  console.log('▶️ loadAlerts() called');
  try {
    const response = await fetch('/systeme/api/alerts/', {
      method: 'GET',
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
        'Content-Type': 'application/json',
      }
    });

    if (response.ok) {
      const data = await response.json();
      displayAlerts(data.alerts || []);
      updateAlertsChart(data.distribution || {});
    } else {
      throw new Error('Erreur de chargement des alertes');
    }
  } catch (error) {
    console.error('Erreur lors du chargement des alertes:', error);
    displayAlertsError();
  }
}

// Fonction pour afficher les alertes
function displayAlerts(alerts) {
  const container = document.getElementById('alerts-container');
  if (!container) return;

  if (alerts.length === 0) {
    container.innerHTML = `
      <div class="flex items-center space-x-3 p-4 bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl border border-green-200">
        <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
        <div class="flex-1">
          <p class="text-sm font-bold text-green-800">Aucune alerte active</p>
          <p class="text-xs text-green-600">Système stable et sécurisé</p>
        </div>
      </div>
    `;
    return;
  }

  const alertsHTML = alerts.slice(0, 5).map(alert => {
    const severityColors = {
      'low': 'from-green-50 to-emerald-50 border-green-200 text-green-800',
      'medium': 'from-yellow-50 to-amber-50 border-yellow-200 text-yellow-800',
      'high': 'from-orange-50 to-red-50 border-orange-200 text-orange-800',
      'critical': 'from-red-50 to-rose-50 border-red-200 text-red-800'
    };

    const severityIcons = {
      'low': 'bg-green-500',
      'medium': 'bg-yellow-500',
      'high': 'bg-orange-500',
      'critical': 'bg-red-500'
    };

    const colorClass = severityColors[alert.severity] || severityColors['medium'];
    const iconClass = severityIcons[alert.severity] || severityIcons['medium'];

    return `
      <div class="flex items-start space-x-3 p-4 bg-gradient-to-r ${colorClass} rounded-xl border transition-all duration-300 hover:scale-105">
        <div class="w-3 h-3 ${iconClass} rounded-full mt-1 animate-pulse"></div>
        <div class="flex-1 min-w-0">
          <p class="text-sm font-bold truncate">${alert.title || 'Alerte système'}</p>
          <p class="text-xs mt-1 opacity-80">${alert.description || 'Description non disponible'}</p>
          <p class="text-xs mt-1 opacity-60">${alert.timestamp || 'Maintenant'}</p>
        </div>
      </div>
    `;
  }).join('');

  container.innerHTML = alertsHTML;
}

// Fonction pour afficher une erreur d'alertes
function displayAlertsError() {
  const container = document.getElementById('alerts-container');
  if (!container) return;

  container.innerHTML = `
    <div class="flex items-center space-x-3 p-4 bg-gradient-to-r from-red-50 to-rose-50 rounded-xl border border-red-200">
      <div class="w-3 h-3 bg-red-500 rounded-full"></div>
      <div class="flex-1">
        <p class="text-sm font-bold text-red-800">Erreur de chargement</p>
        <p class="text-xs text-red-600">Impossible de récupérer les alertes</p>
      </div>
    </div>
  `;
}

// Fonction pour charger les événements récents
async function loadRecentEvents() {
  console.log('▶️ loadRecentEvents() called');
  try {
    const response = await fetch('/systeme/api/recent-events/', {
      method: 'GET',
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
        'Content-Type': 'application/json',
      }
    });

    if (response.ok) {
      const data = await response.json();
      displayRecentEvents(data.events || []);
    } else {
      throw new Error('Erreur de chargement des événements');
    }
  } catch (error) {
    console.error('Erreur lors du chargement des événements:', error);
    displayEventsError();
  }
}

// Fonction pour afficher les événements récents
function displayRecentEvents(events) {
  const container = document.getElementById('events-container');
  if (!container) return;

  if (events.length === 0) {
    container.innerHTML = `
      <div class="text-center py-12 text-gray-500">
        <div class="w-16 h-16 bg-gradient-to-br from-gray-100 to-gray-200 rounded-2xl flex items-center justify-center mx-auto mb-4">
          <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
          </svg>
        </div>
        <p class="font-medium">Aucun événement récent</p>
        <p class="text-sm mt-1">Les nouveaux événements apparaîtront ici</p>
      </div>
    `;
    return;
  }

  const eventsHTML = events.slice(0, 8).map((event, index) => {
    const eventTypes = {
      'connection': { color: 'from-green-50 to-emerald-50 border-green-200', icon: 'bg-green-500', text: 'text-green-800' },
      'disconnection': { color: 'from-red-50 to-rose-50 border-red-200', icon: 'bg-red-500', text: 'text-red-800' },
      'scan': { color: 'from-blue-50 to-indigo-50 border-blue-200', icon: 'bg-blue-500', text: 'text-blue-800' },
      'alert': { color: 'from-amber-50 to-orange-50 border-amber-200', icon: 'bg-amber-500', text: 'text-amber-800' },
      'default': { color: 'from-gray-50 to-slate-50 border-gray-200', icon: 'bg-gray-500', text: 'text-gray-800' }
    };

    const eventStyle = eventTypes[event.type] || eventTypes['default'];

    return `
      <div class="flex items-start space-x-4 p-4 bg-gradient-to-r ${eventStyle.color} rounded-xl border transition-all duration-300 hover:scale-105 transform" style="animation-delay: ${index * 0.1}s">
        <div class="w-3 h-3 ${eventStyle.icon} rounded-full mt-2 flex-shrink-0 animate-pulse"></div>
        <div class="flex-1 min-w-0">
          <p class="text-sm font-bold ${eventStyle.text} truncate">${event.device_name || 'Appareil inconnu'}</p>
          <p class="text-sm ${eventStyle.text} mt-1 opacity-80">${event.description || event.event || 'Événement système'}</p>
          <p class="text-xs ${eventStyle.text} mt-2 opacity-60">${event.timestamp || event.scan_time || 'Maintenant'}</p>
        </div>
      </div>
    `;
  }).join('');

  container.innerHTML = eventsHTML;

  // Animation d'entrée
  const eventElements = container.querySelectorAll('.transform');
  eventElements.forEach((element, index) => {
    element.style.opacity = '0';
    element.style.transform = 'translateY(20px)';
    setTimeout(() => {
      element.style.transition = 'all 0.6s ease';
      element.style.opacity = '1';
      element.style.transform = 'translateY(0)';
    }, index * 100);
  });
}

// Fonction pour afficher une erreur d'événements
function displayEventsError() {
  const container = document.getElementById('events-container');
  if (!container) return;

  container.innerHTML = `
    <div class="flex items-center space-x-3 p-4 bg-gradient-to-r from-red-50 to-rose-50 rounded-xl border border-red-200">
      <div class="w-3 h-3 bg-red-500 rounded-full"></div>
      <div class="flex-1">
        <p class="text-sm font-bold text-red-800">Erreur de chargement</p>
        <p class="text-xs text-red-600">Impossible de récupérer les événements</p>
      </div>
    </div>
  `;
}

// Fonction pour mettre à jour le graphique des alertes
function updateAlertsChart(distribution) {
  const ctx = document.getElementById('alertChart');
  if (!ctx) return;

  if (alertsChart) {
    alertsChart.destroy();
  }

  alertsChart = new Chart(ctx.getContext('2d'), {
    type: 'doughnut',
    data: {
      labels: ['Faible', 'Moyenne', 'Élevée', 'Critique'],
      datasets: [{
        data: [
          distribution.low || 0,
          distribution.medium || 0,
          distribution.high || 0,
          distribution.critical || 0
        ],
        backgroundColor: [colors.success, colors.warning, '#fd7e14', colors.danger],
        borderWidth: 0,
        hoverOffset: 12
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      cutout: '65%',
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            font: { size: 14, weight: '600' },
            color: '#374151',
            usePointStyle: true,
            pointStyle: 'circle',
            padding: 20
          }
        },
        tooltip: {
          backgroundColor: 'rgba(0, 0, 0, 0.9)',
          titleColor: '#ffffff',
          bodyColor: '#ffffff',
          cornerRadius: 12,
          displayColors: true,
          titleFont: { size: 14, weight: 'bold' },
          bodyFont: { size: 13 }
        }
      }
    }
  });
}

// Fonction pour afficher des notifications
function showNotification(message, type = 'info') {
  const colors = {
    success: 'from-green-500 to-emerald-600',
    error: 'from-red-500 to-rose-600',
    warning: 'from-amber-500 to-orange-500',
    info: 'from-blue-500 to-indigo-600'
  };

  const notification = document.createElement('div');
  notification.className = `fixed top-6 right-6 z-50 bg-gradient-to-r ${colors[type]} text-white px-6 py-4 rounded-2xl shadow-2xl transform transition-all duration-500 translate-x-full`;
  notification.innerHTML = `
    <div class="flex items-center space-x-3">
      <div class="w-2 h-2 bg-white rounded-full animate-pulse"></div>
      <span class="font-semibold">${message}</span>
    </div>
  `;

  document.body.appendChild(notification);

  setTimeout(() => notification.classList.remove('translate-x-full'), 100);
  setTimeout(() => {
    notification.classList.add('translate-x-full');
    setTimeout(() => document.body.removeChild(notification), 500);
  }, 4000);
}

// Initialisation des graphiques
function initializeCharts() {
  // Line Chart
  const ctxLine = document.getElementById('devicesLineChart');
  if (ctxLine) {
    new Chart(ctxLine.getContext('2d'), {
      type: 'line',
      data: {
        labels: {{ scan_dates|safe }},
        datasets: [{
          label: 'Appareils détectés',
          data: {{ scan_counts|safe }},
          fill: true,
          backgroundColor: 'rgba(59, 130, 246, 0.1)',
          borderColor: colors.primary,
          borderWidth: 4,
          tension: 0.4,
          pointRadius: 8,
          pointHoverRadius: 12,
          pointBackgroundColor: colors.primary,
          pointBorderColor: '#ffffff',
          pointBorderWidth: 3
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.9)',
            titleColor: '#ffffff',
            bodyColor: '#ffffff',
            borderColor: colors.primary,
            borderWidth: 2,
            cornerRadius: 12,
            displayColors: false,
            titleFont: { size: 14, weight: 'bold' },
            bodyFont: { size: 13 }
          }
        },
        scales: {
          x: {
            grid: { display: false },
            ticks: { color: '#6b7280', font: { size: 12, weight: '500' } }
          },
          y: {
            beginAtZero: true,
            grid: { color: 'rgba(0, 0, 0, 0.05)' },
            ticks: { color: '#6b7280', font: { size: 12, weight: '500' } }
          }
        }
      }
    });
  }

  // Doughnut Chart
  const ctxDough = document.getElementById('statusDoughnutChart');
  if (ctxDough) {
    new Chart(ctxDough.getContext('2d'), {
      type: 'doughnut',
      data: {
        labels: ['En ligne', 'Hors ligne', 'Alertes'],
        datasets: [{
          data: [{{ total_online }}, {{ total_offline }}, {{ total_alerts }}],
          backgroundColor: [colors.success, colors.danger, colors.warning],
          borderWidth: 0,
          hoverOffset: 15
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: '70%',
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              font: { size: 14, weight: '600' },
              color: '#374151',
              usePointStyle: true,
              pointStyle: 'circle',
              padding: 25
            }
          },
          tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.9)',
            titleColor: '#ffffff',
            bodyColor: '#ffffff',
            cornerRadius: 12,
            displayColors: true,
            titleFont: { size: 14, weight: 'bold' },
            bodyFont: { size: 13 }
          }
        }
      }
    });
  }
}

// Animation d'entrée pour les cartes
function animateCards() {
  const cards = document.querySelectorAll('.bg-white\\/90, .group');
  cards.forEach((card, index) => {
    card.style.opacity = '0';
    card.style.transform = 'translateY(30px)';
    setTimeout(() => {
      card.style.transition = 'all 0.8s cubic-bezier(0.4, 0, 0.2, 1)';
      card.style.opacity = '1';
      card.style.transform = 'translateY(0)';
    }, index * 150);
  });
}

// Initialisation
document.addEventListener('DOMContentLoaded', function() {
  console.log('🚀 Initialisation du dashboard...');

  // Initialiser les graphiques
  initializeCharts();

  // Charger les données dynamiques
  loadAlerts();
  loadRecentEvents();

  // Animer les cartes
  setTimeout(animateCards, 300);

  // Actualisation automatique
  setInterval(() => {
    loadAlerts();
    loadRecentEvents();
  }, 30000); // Toutes les 30 secondes

  // Actualisation réseau toutes les 60 secondes
  setInterval(refreshNetworkInfo, 60000);

  console.log('✅ Dashboard initialisé avec succès');
});


  // Affiche le loader pendant le chargement de la page
  document.addEventListener("DOMContentLoaded", function () {
    const loader = document.getElementById('global-loader');
    loader.classList.remove('hidden'); // Afficher

    window.addEventListener('load', function () {
      loader.classList.add('hidden');  // Cacher une fois tout chargé
    });
  });
</script>

<style>
/* Scrollbar personnalisée */
.custom-scrollbar::-webkit-scrollbar {
  width: 6px;
}

.custom-scrollbar::-webkit-scrollbar-track {
  background: #f1f5f9;
  border-radius: 10px;
}

.custom-scrollbar::-webkit-scrollbar-thumb {
  background: linear-gradient(to bottom, #3b82f6, #6366f1);
  border-radius: 10px;
}

.custom-scrollbar::-webkit-scrollbar-thumb:hover {
  background: linear-gradient(to bottom, #2563eb, #4f46e5);
}

/* Animations personnalisées */
@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.animate-fadeInUp {
  animation: fadeInUp 0.8s cubic-bezier(0.4, 0, 0.2, 1) forwards;
}
</style>
{% endblock %}
